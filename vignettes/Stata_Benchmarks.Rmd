<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{Stata Benchmarks}
-->

# Stata Benchmarks #

**margins** is intended as a port of (some of) the features of Stata's `margins` command. This vignette walks through common uses of Stata's `margins` commands and the comparable functionality in using either R's built-in `predict` function or the `margins` function from this package. We will use the `mtcars` dataset. Some of the analyses make little substantive sense; they are only intended to demonstrate package functionality.

---

## OLS predicted values ##

### Stata ###

```
import delimited mtcars.csv
quietly reg mpg cyl hp wt
margins

Predictive margins                                Number of obs   =         32
Model VCE    : OLS

Expression   : Linear prediction, predict()

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |   20.09062   .4439833    45.25   0.000     19.18117    21.00008
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- lm(mpg ~ cyl + hp + wt, data = mtcars)
mean(predict(x))
```


## OLS predicted values at specified covariate levels ##

### Stata ###

```
margins, at(cyl = (4 6 8))

Predictive margins                                Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()
1._at        : cyl             =           4
2._at        : cyl             =           6
3._at        : cyl             =           8

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   22.15041   1.284313    17.25   0.000     19.51962    24.78121
          2  |   20.26718   .4558414    44.46   0.000     19.33343    21.20093
          3  |   18.38394   1.092793    16.82   0.000     16.14546    20.62243
------------------------------------------------------------------------------
```


### R ###

```{r}
n <- expand.grid(cyl = c(4,6,8), hp = mean(mtcars$hp), wt = mean(mtcars$wt))
predict(x, newdata = n)
```

---

## GLM predicted values ##

### Stata ###

```
quietly logit am cyl hp wt
* probability of success
margins 

Predictive margins                                Number of obs   =         32
Model VCE    : OIM

Expression   : Pr(am), predict()

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |     .40625   .0370796    10.96   0.000     .3335752    .4789248
------------------------------------------------------------------------------

* Linear prediction
margins, predict(xb) 

Predictive margins                                Number of obs   =         32
Model VCE    : OIM

Expression   : Linear prediction (log odds), predict(xb)

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |   -1.93545   1.144232    -1.69   0.091    -4.178104    .3072045
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- glm(am ~ cyl + hp + wt, data = mtcars, family=binomial)
mean(predict(x, type = "response")) # Probability of success
mean(predict(x)) # linear prediction
```

## GLM predicted values at specified covariate levels ##


### Stata ###

```
* average predictive margins
margins, at(cyl = (4 6 8))

Predictive margins                                Number of obs   =         32
Model VCE    : OIM
Expression   : Pr(am), predict()
1._at        : cyl             =           4
2._at        : cyl             =           6
3._at        : cyl             =           8

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   .3618736   .1065746     3.40   0.001     .1529913     .570756
          2  |   .4022889   .0363634    11.06   0.000      .331018    .4735599
          3  |    .439427   .0671516     6.54   0.000     .3078122    .5710418
------------------------------------------------------------------------------

* holding all other variables at means
margins, at(cyl = (4 6 8)) atmeans 

Adjusted predictions                              Number of obs   =         32
Model VCE    : OIM
Expression   : Pr(am), predict()
1._at        : cyl             =           4
               hp              =    146.6875 (mean)
               wt              =     3.21725 (mean)
2._at        : cyl             =           6
               hp              =    146.6875 (mean)
               wt              =     3.21725 (mean)
3._at        : cyl             =           8
               hp              =    146.6875 (mean)
               wt              =     3.21725 (mean)

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   .0473325   .1307238     0.36   0.717    -.2088814    .3035464
          2  |   .1164102   .1254196     0.93   0.353    -.1294077    .3622281
          3  |   .2589031   .3718624     0.70   0.486    -.4699337    .9877399
------------------------------------------------------------------------------
```


### R ###

```{r}
# average predictive margins
sapply(c(4,6,8), function(z) {
    mean(predict(x, newdata = `[<-`(x$model, , "cyl", z), type = "response"))
})

# holding all other variables at their means
n <- expand.grid(cyl = c(4,6,8), hp = mean(mtcars$hp), wt = mean(mtcars$wt))
predict(x, newdata = n, type = "response")
```

---

## OLS predicted values with interactions ##

### Stata ###

```
quietly reg mpg i.cyl##c.hp wt
margins

Predictive margins                                Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |   20.09062   .4065514    49.42   0.000     19.25332    20.92793
------------------------------------------------------------------------------


margins cyl

Predictive margins                                Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |
          4  |   17.44233   2.372914     7.35   0.000     12.55522    22.32944
          6  |    18.9149   1.291483    14.65   0.000     16.25505    21.57476
          8  |   18.33318   1.123874    16.31   0.000     16.01852    20.64785
------------------------------------------------------------------------------

```

### R ###

```{r}
x <- lm(mpg ~ factor(cyl) * hp + wt, data = mtcars)
mean(predict(x))

sapply(c(4,6,8), function(z) {
    mean(predict(x, newdata = `[<-`(x$model, , "cyl", z)))
})
```

---

## GLM predicted values with interactions ##

### Stata ###

```
quietly logit am i.cyl##c.hp wt
margins

Predictive margins                                Number of obs   =         32
Model VCE    : OIM
Expression   : Pr(am), predict()

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |   .4062558    .031352    12.96   0.000     .3448069    .4677046
------------------------------------------------------------------------------

margins cyl

Predictive margins                                Number of obs   =         32
Model VCE    : OIM
Expression   : Pr(am), predict()

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |
          4  |   .4475668   .1511923     2.96   0.003     .1512353    .7438982
          6  |   .4545709   .3008264     1.51   0.131    -.1350381     1.04418
          8  |      .0625   1.96e-08  3.2e+06   0.000        .0625       .0625
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- glm(am ~ factor(cyl) * hp + wt, data = mtcars, family=binomial)
mean(predict(x, type = "response"))

sapply(c(4,6,8), function(z) {
    mean(predict(x, newdata = `[<-`(x$model, , "cyl", z), type = "response"))
})
```


## OLS marginal effects at means ##

### Stata ###

```
quietly reg mpg cyl hp wt
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : cyl hp wt
at           : cyl             =      6.1875 (mean)
               hp              =    146.6875 (mean)
               wt              =     3.21725 (mean)

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |  -.9416166   .5509165    -1.71   0.098    -2.070118    .1868846
          hp |  -.0180381   .0118763    -1.52   0.140    -.0423655    .0062893
          wt |  -3.166973    .740576    -4.28   0.000    -4.683975   -1.649972
------------------------------------------------------------------------------
```

### R ###

```{r}
library("margins")
x <- lm(mpg ~ cyl + hp + wt, data = mtcars)
margins(x, atmeans = TRUE)
```

---

## OLS average marginal effects ##


### Stata ###

```
quietly reg mpg cyl hp wt
margins, dydx(*)

Average marginal effects                          Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : cyl hp wt

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |  -.9416166   .5509165    -1.71   0.098    -2.070118    .1868846
          hp |  -.0180381   .0118763    -1.52   0.140    -.0423655    .0062893
          wt |  -3.166973    .740576    -4.28   0.000    -4.683975   -1.649972
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- lm(mpg ~ cyl + hp + wt, data = mtcars)
margins(x)
```


## OLS marginal effects with interaction at means ##

### Stata ###

```
quietly reg mpg cyl c.hp##c.wt
margins, dydx(*) atmeans

onditional marginal effects                      Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : cyl hp wt
at           : cyl             =      6.1875 (mean)
               hp              =    146.6875 (mean)
               wt              =     3.21725 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |  -.3652391   .5086204    -0.72   0.479    -1.408842    .6783638
          hp |  -.0252715   .0105097    -2.40   0.023    -.0468357   -.0037073
          wt |  -3.837584   .6730996    -5.70   0.000     -5.21867   -2.456498
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- lm(mpg ~ cyl + hp * wt, data = mtcars)
margins(x, atmeans = TRUE)
```

---

## OLS average marginal effects with interaction ##


### Stata ###

```
quietly reg mpg cyl c.hp##c.wt
margins, dydx(*)

Average marginal effects                          Number of obs   =         32
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : cyl hp wt

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |  -.3652391   .5086204    -0.72   0.479    -1.408842    .6783638
          hp |  -.0252715   .0105097    -2.40   0.023    -.0468357   -.0037073
          wt |  -3.837584   .6730996    -5.70   0.000     -5.21867   -2.456498
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- lm(mpg ~ cyl + hp * wt, data = mtcars)
margins(x)
```



## GLM marginal effects at means with interaction ##

### Stata ###

```
quietly logit am cyl c.hp##c.wt
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =         32
Model VCE    : OIM
Expression   : Pr(am), predict()
dy/dx w.r.t. : cyl hp wt
at           : cyl             =      6.1875 (mean)
               hp              =    146.6875 (mean)
               wt              =     3.21725 (mean)

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |   .0810915   .1838916     0.44   0.659    -.2793294    .4415125
          hp |   .0081009   .0086664     0.93   0.350    -.0088849    .0250867
          wt |  -1.925325   1.866456    -1.03   0.302    -5.583512    1.732861
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- glm(am ~ cyl + hp * wt, data = mtcars, family=binomial)
margins(x, atmeans = TRUE)
```

---

## GLM average marginal effects with interaction ##


### Stata ###

```
quietly logit am cyl c.hp##c.wt
margins, dydx(*)

Average marginal effects                          Number of obs   =         32
Model VCE    : OIM
Expression   : Pr(am), predict()
dy/dx w.r.t. : cyl hp wt

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         cyl |   .0215633   .0492676     0.44   0.662    -.0749994    .1181261
          hp |   .0026673   .0023004     1.16   0.246    -.0018414     .007176
          wt |  -.5157922   .2685806    -1.92   0.055    -1.042201    .0106162
------------------------------------------------------------------------------
```

### R ###

```{r}
x <- glm(am ~ cyl + hp * wt, data = mtcars, family=binomial)
margins(x)
```


---

## Linear Panel Model (Pooling) marginal effects at means ##

### Stata ###

```
xtset state year
quietly reg sales price pop cpi
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =       1380
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
at           : price           =    68.69993 (mean)
               pop             =    4537.113 (mean)
               cpi             =    73.59667 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |   -.818001   .0577155   -14.17   0.000    -.9312209   -.7047811
         pop |  -.0003927   .0001585    -2.48   0.013    -.0007037   -.0000817
         cpi |   .7182534   .0661716    10.85   0.000     .5884452    .8480615
------------------------------------------------------------------------------
```

### R ###

```{r}
library("plm")
data(Cigar)
x <- plm(sales ~ price + pop + cpi, data = Cigar, model = "pooling")
margins(x)
```



## Linear Panel Model (Pooling) average marginal effects ##

### Stata ###

```
xtset state year
quietly reg sales price pop cpi
margins, dydx(*)

Average marginal effects                          Number of obs   =       1380
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |   -.818001   .0577155   -14.17   0.000    -.9312209   -.7047811
         pop |  -.0003927   .0001585    -2.48   0.013    -.0007037   -.0000817
         cpi |   .7182534   .0661716    10.85   0.000     .5884452    .8480615
------------------------------------------------------------------------------
```

### R ###

```{r}
library("plm")
data(Cigar)
x <- plm(sales ~ price + pop + cpi, data = Cigar, model = "pooling")
margins(x)
```


---

## Linear Fixed Effects Panel Model marginal effects at means ##

### Stata ###

```
xtset state year
quietly xtreg sales price pop cpi, fe
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
at           : price           =    68.69993 (mean)
               pop             =    4537.113 (mean)
               cpi             =    73.59667 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.6994539   .0302887   -23.09   0.000    -.7588187    -.640089
         pop |   .0001777   .0005044     0.35   0.725    -.0008108    .0011663
         cpi |   .5827791   .0346912    16.80   0.000     .5147857    .6507726
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop + cpi, data = Cigar, model = "within", index = c("state", "year"))
#margins(x)
#x <- lm(sales ~ price + pop + cpi + factor(state), data = Cigar)
#summary(margins(x))[1:3,]
```



## Linear Fixed Effects Panel Model average marginal effects ##

### Stata ###

```
xtset state year
quietly xtreg sales price pop cpi, fe
margins, dydx(*)

Average marginal effects                          Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.6994539   .0302887   -23.09   0.000    -.7588187    -.640089
         pop |   .0001777   .0005044     0.35   0.725    -.0008108    .0011663
         cpi |   .5827791   .0346912    16.80   0.000     .5147857    .6507726
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop + cpi, data = Cigar, model = "within", index = c("state","year"))
#margins(x)
#x <- lm(sales ~ price + pop + cpi + factor(state), data = Cigar)
#summary(margins(x))[1:3,]
```

---

## Linear Random Effects Panel Model marginal effects at means ##

### Stata ###

```
xtset state year
quietly xtreg sales price pop cpi
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
at           : price           =    68.69993 (mean)
               pop             =    4537.113 (mean)
               cpi             =    73.59667 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |   -.700356   .0302552   -23.15   0.000    -.7596551   -.6410569
         pop |  -2.44e-06   .0004238    -0.01   0.995    -.0008331    .0008283
         cpi |   .5857053   .0345976    16.93   0.000     .5178952    .6535154
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop + cpi, data = Cigar, model = "random", index = c("state","year"))
#margins(x)
```



## Linear Random Effects Panel Model average marginal effects ##

### Stata ###

```
xtset state year
quietly xtreg sales price pop cpi
margins, dydx(*)

Average marginal effects                          Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |   -.700356   .0302552   -23.15   0.000    -.7596551   -.6410569
         pop |  -2.44e-06   .0004238    -0.01   0.995    -.0008331    .0008283
         cpi |   .5857053   .0345976    16.93   0.000     .5178952    .6535154
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop + cpi, data = Cigar, model = "random", index = c("state","year"))
#margins(x)
```



---

## Linear Panel Model (Pooling) marginal effects at means with interaction ##

### Stata ###

```
xtset state year
quietly reg sales price c.pop##c.cpi
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =       1380
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
at           : price           =    68.69993 (mean)
               pop             =    4537.113 (mean)
               cpi             =    73.59667 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.8221654   .0579823   -14.18   0.000    -.9359088    -.708422
         pop |  -.0004153   .0001613    -2.57   0.010    -.0007318   -.0000989
         cpi |   .7226397   .0664315    10.88   0.000     .5923217    .8529577
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop * cpi, data = Cigar, model = "pooling")
#margins(x)
```



## Linear Panel Model (Pooling) average marginal effects with interaction ##

### Stata ###

```
xtset state year
quietly reg sales price c.pop##c.cpi
margins, dydx(*)

Average marginal effects                          Number of obs   =       1380
Model VCE    : OLS
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.8221654   .0579823   -14.18   0.000    -.9359088    -.708422
         pop |  -.0004153   .0001613    -2.57   0.010    -.0007318   -.0000989
         cpi |   .7226397   .0664315    10.88   0.000     .5923217    .8529577
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop * cpi, data = Cigar, model = "pooling")
#margins(x)
```


---

## Linear Fixed Effects Panel Model marginal effects at means with interaction ##

### Stata ###

```
xtset state year
quietly xtreg sales price c.pop##c.cpi, fe
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
at           : price           =    68.69993 (mean)
               pop             =    4537.113 (mean)
               cpi             =    73.59667 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.7016593   .0304284   -23.06   0.000    -.7612978   -.6420208
         pop |  -.0001637   .0006715    -0.24   0.807    -.0014799    .0011525
         cpi |   .5886036   .0355108    16.58   0.000     .5190037    .6582035
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop * cpi, data = Cigar, model = "within", index = c("state", "year"))
#margins(x)
#x <- lm(sales ~ price + pop * cpi + factor(state), data = Cigar)
#summary(margins(x))[1:3,]
```



## Linear Fixed Effects Panel Model average marginal effects with interaction ##

### Stata ###

```
xtset state year
quietly xtreg sales price c.pop##c.cpi, fe
margins, dydx(*)

Average marginal effects                          Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.7016593   .0304284   -23.06   0.000    -.7612978   -.6420208
         pop |  -.0001637   .0006715    -0.24   0.807    -.0014799    .0011525
         cpi |   .5886036   .0355108    16.58   0.000     .5190037    .6582035
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop * cpi, data = Cigar, model = "within", index = c("state","year"))
#margins(x)
#x <- lm(sales ~ price + pop * cpi + factor(state), data = Cigar)
#summary(margins(x))[1:3,]
```

---

## Linear Random Effects Panel Model marginal effects at means with interaction ##

### Stata ###

```
xtset state year
quietly xtreg sales price c.pop##c.cpi
margins, dydx(*) atmeans

Conditional marginal effects                      Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
at           : price           =    68.69993 (mean)
               pop             =    4537.113 (mean)
               cpi             =    73.59667 (mean)
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.7031592   .0303831   -23.14   0.000     -.762709   -.6436094
         pop |  -.0002812   .0005135    -0.55   0.584    -.0012876    .0007253
         cpi |   .5914665   .0350954    16.85   0.000     .5226809    .6602522
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop * cpi, data = Cigar, model = "random", index = c("state","year"))
#margins(x)
```



## Linear Random Effects Panel Model average marginal effects with interaction ##

### Stata ###

```
xtset state year
quietly xtreg sales price c.pop##c.cpi
margins, dydx(*)

Average marginal effects                          Number of obs   =       1380
Model VCE    : Conventional
Expression   : Linear prediction, predict()
dy/dx w.r.t. : price pop cpi
------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.7031592   .0303831   -23.14   0.000     -.762709   -.6436094
         pop |  -.0002812   .0005135    -0.55   0.584    -.0012876    .0007253
         cpi |   .5914665   .0350954    16.85   0.000     .5226809    .6602522
------------------------------------------------------------------------------
```

### R ###

```{r}
#library("plm")
#data(Cigar)
#x <- plm(sales ~ price + pop * cpi, data = Cigar, model = "random", index = c("state","year"))
#margins(x)
```

